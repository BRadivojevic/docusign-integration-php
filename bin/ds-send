#!/usr/bin/env php
<?php
require __DIR__.'/../vendor/autoload.php';

use App\Config\Config;
use App\Logger\LoggerFactory;
use App\Queue\FileJobStore;
use App\Queue\SqliteJobStore;

$root = dirname(__DIR__);
$cfg = new Config($root);
$logger = LoggerFactory::make('cli', $cfg->logPath());

$args = [];
foreach (array_slice($argv,1) as $a) { if (strpos($a,'=')!==false) { [$k,$v]=explode('=',$a,2); $args[$k]=$v; } }

$payload = [
    'type' => 'send_envelope',
    'email' => $args['email'] ?? 'recipient@example.com',
    'name' => $args['name'] ?? 'Test Signer',
    'pdf_path' => $args['pdf'] ?? __DIR__.'/../public/demo.pdf',
    'subject' => $args['subject'] ?? 'Please sign (CLI)'
];

if ($cfg->jobStore() === 'sqlite') {
    $store = new SqliteJobStore($root.'/var/jobs.sqlite');
} else {
    $store = new FileJobStore($cfg->jobsFile());
}
$jobId = $store->enqueue($payload);
echo $jobId."\n";
